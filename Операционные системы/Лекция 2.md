# Прерывания в вычислительной системы. Порядок их обработки

Прерывание - принудительная преедача управления от управляемой программы к системе, а от нее - к обработчику прерывания.

Прерывания связаны с теми или иными событиями.
Прерывания бывают:
1. Внутренние
	Это связано с внутренними процессами.
	Пример: деление на ноль, обращение к чужой памяти

2. Внешние
	Их причиной могут быть тайм-ауты
	Они чаще 

Также прерывания можно разделить на аппаратные и программные:
	Аппаратные вызываются по аппаратным причинам
	Программные вызываются другими программами или прямым обращением к обработчику

Порядок обработки прерывания отличий нет.

### Порядок обработки прерываний
0. После появления команды прерывания ТЕКУЩАЯ команда прерываемой программы выполняется до конца.
1. Идентификация прерывания. Она осуществляется, обычно, аппаратным способом.
2. Запоминается состояние прерываемой программы.
	Состояние обычно фиксируется в регистре процессора (в оперативной памяти, конкретнее - в системном стеке)
3. Передача управления обработчику прерывания.
4. Запоминание содержимого необходимых регистров процессора.
5. Выполнение обработчика прерывания.
6. Переход к выполнению раннее прерванной программы.

П. 1-3 выполняются аппаратно, остальные - программно.

Очевидно, должен быть определенный порядок прерываний

Приоритетность прерывания (по убыванию):
1. От схем контроля процессора.
2. Прерывание по таймеру.
3. Прерывание от дисков/внешней памяти.
4. Прерывание от сетевого оборудования.
5. Прерывание терминалов.
6. Программное прерывание.

На основании этого реализуется порядок прерывания.

В составе современных ПК есть аппаратная часть для запоминания прерываемого процесса, его задерживания
Программная состовляющая состоит в дисциплине прерывания:
1. Дисциплина на основе относительных приоритетов.
	Выполняется некоторый обработчик прерывания. Если в интервал времени обработчика появляется более приоритетный процесс для прерывания, то он сначала доделает текущий, а потом перейдет к другому.
2. На основе абсолютных приоритетов:
	Если во время обработки прерывания появляется более высокий приоритет по прерыванию, то прерывается сам обработчик, после происходит прерывание максимального приоритета. Прерванное прерывание продолжается.
3. LCFS - last come first served.
	Первым выполняется тот обработчик, который пришел последним (это характерно для спец. вычислителей)

Компонента, реализующая ту или иную дисциплину должна входить в состав ОС. Она называется диспетчер/супервизор прерывания.
* Они часто пересекаются с супервизором ввода/вывода.

## Архитектура ОС

Операционная система имеет модульную структуру (как и любое другое ПО).
Часто используемые модули должны выполнятся максимально быстро. Они образуют своей совокупностью ядро ОС.

Ядро ОС ВСЕГДА хранится в оперативной памяти, как раз для обеспечения быстродействия.

Остальные модули () являются диск-резидентными. Они хранятся на диске и уходят в ОЗУ только в процессе своего выполнения.

Все множество модулей из ядра ОС делятся на модули однократного использования и многократного использования:
	Модули однократного использования записаны в виде абсолютных команд, они короткие. Прикол в том, что "они портят сами себя"
	Однако основными модулями являются модули многократного примения. Они делятся на:
	1. Модули непривилегированные (их мало, они короткие и быстрые). Их можно прервать, а при продолжении выполнения они будут выполнены с самого начала.
	2. Привилегированные модули (их много). Если такой модуль выполняется, то его прервать нельзя. Он выполнится от начала до конца.
	3. Реентерабельные модули - модули, которые можно прервать, но промежуточные результаты фиксируются. При повторном обращении он продолжит выполнение с точки прерывания. Они характерны для драйверов. В минимальном варианте он состоит из трех секций:
		1. Выделение памяти для хранения промежуточных результатов
		2. Реализация соответствующего функционала
		3. Освобождение памяти.
		Секции 1 и 3 оформляются как привилегированные секции 
	4. Повторно входимые модули - модули, состоящие из множества привилегированных секций. Только на уровне секций он может прерываться.


## Привилегированный режим работы ядра

При создании мультипрограммных вычислительных систем нужно повысить уровень ее работы. Для этого нужно экранировать пользователя и внешние устройства от внутряка.

Привилегированный режим - режим, когда может работать только ядро ОС. Только ядро позволяет определять доступ к ресурсам.

Тогда процессор работает в двухконтекстном режиме:
1. В привилегированном (он же режим ядра)
2. В пользовательском/непривилегированном режиме

Допустим, приложение работает в пользовательском режиме. В определенный момент приложение запрашивает что-то от API. После этого осуществляется переход в привилегированный режим (он осуществляется НЕ МГНОВЕННО), осуществляется работа в привилегированный режим, потом переходный процесс назад и далее программа продолжает работу в пользовательском режиме.

## Структура ядра ОС

Структура ядра носит многослойный характер.

Можно выделить 5 слоев:
1. Средства аппаратной поддержки ОС
	Очевидно, что это аппаратный срез. Но он в основном лежит в процессоре.
	Самый глубокий слой
2. Машинно-зависимые компоненты ядра
	Они написаны на соответствующем ассемблере. Он д.б. максимально коротким и простым.
	Уже уровнем выше
3. Базовые механизмы ядра
	Здесь лежат модули с максимально простыми алгоритмами, которые недоступны пользовательским программам
4. Менеджеры ресурсов
	Объемный и сложный слой из сложных и больших модулей, они выполняют уже некоторые управляющие процессы, сами связаны между собой.
5. Интерфейс системных вызовов
	Слой, реализующий множество API

Реально такого строгого разделения на слои нет. И если в винде есть иерархия, то в линуксе ее найти крайне сложно.

## Микроядераня архитектура ОС

Микроядро - это первые три слоя из иерархии выше. Оно функционирует в привилегированном режиме.
4-й слой является диск-резидентным и называется серверами. Они будут работать в пользовательском режиме
Чтоб приложение получило доступ к серверу, она может его получить только через микроядро.

Достоинства микроядерной архитектуры:
1. Высокая степень переносимости на различные аппаратные платформы.
	Это обусловлено тем, что весь машинный код содержится в микроядре
2. Высокая степень расширяемости
	Удобнее и проще расширять возможности ОС, т.к. они могут быть находиться в разряде серверов. Поэтому ее модификация технологически проще.
3. Более высокая надежность
	Коды различных серверов не пересекаются, поэтому они друг другу никак не мешают

ГЛАВНЫЙ НЕДОСТАТОК - за время выполнения нужно осуществить 4 процесса перехода между привилегированным и программным режимами. А это будет долго относительно.

# Планирование и диспетчеризация процессов

## Дескрипторы задач

Планирование процессов (задач) - процесс определения порядка получения ресурсов процессора для выполнения задач.
Планирование для любого процесса связано с переходом из состояния бездействия в состояние готовности. В основном, этот переход осуществляется однократно.

Для определения очередности предоставления процессора к готовым для выполнения процессам (задачам) используется диспетчеризация.
Для процесса это связано с переходом из состояния готовности в выполнение и иногда обратно. Эти переходы могут быть многократными.

Дескриптор задач - это информационная структура, в которой хранятся характеристики задач, необходимые для цели управления со стороны ОС.
Дескрипторы создаются на этапе трансляции задач. Этот дескриптор загружается так же, как и код задач. Дескриптор содержит в себе десятки и сотни машинных слов.

Характеристики задач, которые уходят в дескриптор:
1. Информация, идентифицирующая задачу:
	Это имя и тип задачи
2. Информация о ресурсах, нужных задаче для выполнения
	Зачастую, это информация с внешних устройств (ввода/вывода)
3. Информация о текущем состоянии задач.
4. Информация о родственных связях задач.
5. Информация цели планирования и диспетчеризации
	Указывается приоритет задачи.
	В дескрипторе есть поля с адресами, указывающими на соседние дескрипторы. Вот и они там указываются. Этим занимается ОС

Дескрипторы - это часть очередей